%-----------------------------------------------------------------------------%
%                                                                             %
%    K A P I T E L   3                                                      %
%                                                                             %
%-----------------------------------------------------------------------------%

\chapter{Contact Stability Constrained DDP}\label{c3}
\section{The Idea}

\section{Center of Pressure Constraints}
\subsection{Center of Pressure (CoP) Conditions}
Conditions for \gls{CoP} inside convex hull:
\begin{align}
\begin{split}
Pitch:& -X \leq C_x \leq X \\
Roll:& -Y \leq C_y \leq Y
\end{split}
\end{align}
Represented by the four inequality conditions:
\begin{align*}
\begin{split}
-X &\leq C_x \\
C_x &\leq X \\
-Y &\leq C_y \\
C_y &\leq Y \\
\end{split}
\end{align*}
Rewritten for readability as
\begin{align}
\begin{split}
X + C_x \geq 0 \\
X - C_x \geq 0 \\
Y + C_y \geq 0 \\
Y - C_y \geq 0 \\
\end{split}
\end{align}

\subsection{CoP Computation}
\begin{equation}
\bp_{CoP}=\dfrac{\bn\times\myM{\btau_O^c}}{\bfun^c\cdot\bn} = \dfrac{\begin{bmatrix} n_x \\ n_y \\ n_z \end{bmatrix} \times \begin{bmatrix} t_x \\ t_y \\ t_z \end{bmatrix}}{\begin{bmatrix} f_x \\ f_y \\ f_z \end{bmatrix} \cdot \begin{bmatrix} n_x \\ n_y \\ n_z \end{bmatrix}} = 
\begin{bmatrix} n_yt_z - n_zt_y \\ n_zt_x-n_xt_z \\ n_xt_y-n_yt_x \end{bmatrix}\cdot \dfrac{1}{f_xn_x+f_yn_y+f_zn_y}
\end{equation}

\begin{subequations}
\begin{align}
C_x&=\dfrac{n_yt_z - n_zt_y}{f_xn_x+f_yn_y+f_zn_y} \\
C_y&=\dfrac{n_zt_x-n_xt_z}{f_xn_x+f_yn_y+f_zn_y}
\end{align}
\end{subequations}

\subsection{CoP Constraints: General Case}
\begin{align}
\begin{split}
X + \dfrac{n_yt_z - n_zt_y}{f_xn_x+f_yn_y+f_zn_y} \geq 0 \\
X - \dfrac{n_yt_z - n_zt_y}{f_xn_x+f_yn_y+f_zn_y} \geq 0 \\
Y + \dfrac{n_zt_x-n_xt_z}{f_xn_x+f_yn_y+f_zn_y} \geq 0 \\
Y - \dfrac{n_zt_x-n_xt_z}{f_xn_x+f_yn_y+f_zn_y} \geq 0 \\
\end{split}
\end{align}
These conditions can be written in matrix form as:  
\begin{equation}
\begin{bmatrix}  
Xn_0 & Xn_1 & Xn_2 & 0 & -n_2 & n_1 \\
Xn_0 & Xn_1 & Xn_2 & 0 & n_2 & -n_1 \\
Yn_0 & Yn_1 & Yn_2 & n_2 & 0 & -n_0 \\
Yn_0 & Yn_1 & Yn_2 & -n_2 & 0 & n_0 \\ \end{bmatrix} \cdot
\begin{bmatrix} f^x \\ f^y \\ f^z \\ \tau^x \\ \tau^y \\ \tau^z \end{bmatrix} \geq
\begin{bmatrix} 0 \\ 0 \\ 0 \\ 0 \end{bmatrix}
\end{equation}

\subsection{CoP Constraints: Special Case of Horizontal Floor}
For the case of horizontal floor, with the according normal vector $\myM{n}=[0,0,1]$, the \gls{CoP} can be computed to: 
\begin{equation}
\myM{p}_{CoP} = \begin{bmatrix} -t_y/f_z \\ t_x/f_z \\ 0 \end{bmatrix}
\end{equation}
Represented by the four inequality conditions:
\begin{align}
\begin{split}
X-\dfrac{\tau_y}{f_z} &\geq 0 \\
X+\dfrac{\tau_y}{f_z} &\geq 0 \\
Y+\dfrac{\tau_x}{f_z} &\geq 0 \\
Y-\dfrac{\tau_x}{f_z} &\geq 0 \\
\end{split}
\end{align}
These conditions are be implemented via: 
\begin{equation}
\begin{bmatrix} 
0 & 0 & X & 0 & -1 & 0 \\
0 & 0 & X & 0 & 1 & 0 \\
0 & 0 & Y & 1 & 0 & 0 \\
0 & 0 & Y & -1 & 0 & 0 \end{bmatrix} \cdot
\begin{bmatrix} f^x \\ f^y \\ f^z \\ \tau^x \\ \tau^y \\ \tau^z \end{bmatrix} \geq
\begin{bmatrix} 0 \\ 0 \\ 0 \\ 0 \end{bmatrix}
\end{equation}


\section{Integration into the Crocoddyl Framework}
\subsection{Inequality Constraints by Penalization}
%CostModelSum, 
%Contact/Impulse Dynamics Action Models, 
%Residual, 
%Activation

\subsection{Computing the Residual}
Computation of the cost residual: 
\begin{equation}
\myM{r} = \myM{A} * \myM{w}
\end{equation}

Computation of the cost value via a bounded, quadratic activation:
\begin{align}
\begin{split}
cost(r) = 0.5 \cdot ||r||^2 &\mid lb >= r >= ub \\
cost(r) = 0 &\mid lb < r < ub \\
\end{split}
\end{align}

Details: 
cost = 0.5 * sqaredNorm(r - lb) + 0.5 * sqaredNorm(r - ub) 
i.e. everything lower than lb and greater than ub will affect the cost. 

\subsection{Unit-Testing Numerical Differentiation} 

%\subsection{Backup: Friction Cone constraints}
%\begin{align}
%\begin{split}
%\mid\mid f^x\mid\mid &\leq \mu f^z \\
%\mid\mid f^y\mid\mid &\leq \mu f^z \\
%f^z &> 0
%\end{split}
%\end{align}
%For the case of four edges of the linear approximation of the friction cone, the equations become:
%\begin{equation}
%\begin{bmatrix} 1 & 0 & -\mu \\
%-1 & 0 & -\mu \\
%0 & 1 & -\mu \\
%0 & -1 & -\mu \\
%0 & 0 & -\mu \\ \end{bmatrix} \cdot
%\begin{bmatrix} f^x \\ f^y \\ f^z \end{bmatrix} \leq
%\begin{bmatrix} 0 \\ 0 \\ 0 \\ 0 \\ 0 \end{bmatrix}
%\end{equation}





