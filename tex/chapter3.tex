%-----------------------------------------------------------------------------%
%                                                                             %
%    K A P I T E L   3                                                      %
%                                                                             %
%-----------------------------------------------------------------------------%

\chapter{Contact Stability Constrained DDP}\label{c3}
\section{Idea: Constraining the CoP of each Contact Surface}

\section{Center of Pressure Constraints}
\subsection{Center of Pressure (CoP) Conditions}
Conditions for \gls{CoP} inside convex hull:
\begin{align}
\begin{split}
Pitch:& -X \leq C_x \leq X \\
Roll:& -Y \leq C_y \leq Y
\end{split}
\end{align}
Represented by the four inequality conditions:
\begin{align}
\begin{split}
-X &\leq C_x \\
C_x &\leq X \\
-Y &\leq C_y \\
C_y &\leq Y \\
\end{split}
\end{align}

\subsection{CoP Computation}
\begin{equation}
\myM{p}_{CoP} = \dfrac{\myM{n}\times\myM{M}}{\myM{F}\cdot\myM{n}} = \dfrac{\begin{bmatrix} n_x \\ n_y \\ n_z \end{bmatrix} \times \begin{bmatrix} t_x \\ t_y \\ t_z \end{bmatrix}}{\begin{bmatrix} f_x \\ f_y \\ f_z \end{bmatrix} \cdot \begin{bmatrix} n_x \\ n_y \\ n_z \end{bmatrix}} = 
\begin{bmatrix} n_yt_z - n_zt_y \\ n_zt_x-n_xt_z \\ n_xt_y-n_yt_x \end{bmatrix}\cdot \dfrac{1}{f_xn_x+f_yn_y+f_zn_y}
\end{equation}

\subsection{CoP Constraints: General Case}
These conditions are be implemented via: 
\begin{equation}
\begin{bmatrix} -Yn_0 & -Yn_1 & -Yn_2 & -n_2 & 0 & n_0 \\
-Yn_0 & -Yn_1 & -Yn_2 & n_2 & 0 & -n_0 \\
-Xn_0 & -Xn_1 & -Xn_2 & 0 & n_2 & -n_1 \\
-Xn_0 & -Xn_1 & -Xn_2 & 0 & -n_2 & n_1 \\ \end{bmatrix} \cdot
\begin{bmatrix} f^x \\ f^y \\ f^z \\ \tau^x \\ \tau^y \\ \tau^z \end{bmatrix} \leq
\begin{bmatrix} 0 \\ 0 \\ 0 \\ 0 \end{bmatrix}
\end{equation}

\subsection{CoP Constraints: Special Case of Horizontal Floor}
For the case of horizontal floor, with the according normal vector $\myM{n}=[0,0,1]$, the \gls{CoP} can be computed to: 
\begin{equation}
\myM{p}_{CoP} = \begin{bmatrix} -t_y/f_z \\ t_x/f_z \\ 0 \end{bmatrix}
\end{equation}
Represented by the four inequality conditions:
\begin{align}
\begin{split}
\tau^x &\leq Yf^z \\
-\tau^x &\leq Yf^z \\
\tau^y &\leq Yf^z \\
-\tau^y &\leq Yf^z 
\end{split}
\end{align}
Briefly summarized as:
\begin{align}
\begin{split}
\mid\mid\tau^x\mid\mid &\leq Yf^z \\
\mid\mid\tau^y\mid\mid &\leq Xf^z 
\end{split}
\end{align}
These conditions are be implemented via: 
\begin{equation}
\begin{bmatrix} 0 & 0 & -Y & 1 & 0 & 0 \\
0 & 0 & -Y & -1 & 0 & 0 \\
0 & 0 & -X & 0 & 1 & 0 \\
0 & 0 & -X & 0 & -1 & 0 \end{bmatrix} \cdot
\begin{bmatrix} f^x \\ f^y \\ f^z \\ \tau^x \\ \tau^y \\ \tau^z \end{bmatrix} \leq
\begin{bmatrix} 0 \\ 0 \\ 0 \\ 0 \end{bmatrix}
\end{equation}





\subsection{Backup: Friction Cone constraints}
\begin{align}
\begin{split}
\mid\mid f^x\mid\mid &\leq \mu f^z \\
\mid\mid f^y\mid\mid &\leq \mu f^z \\
f^z &> 0
\end{split}
\end{align}
For the case of four edges of the linear approximation of the friction cone, the equations become:
\begin{equation}
\begin{bmatrix} 1 & 0 & -\mu \\
-1 & 0 & -\mu \\
0 & 1 & -\mu \\
0 & -1 & -\mu \\
0 & 0 & -\mu \\ \end{bmatrix} \cdot
\begin{bmatrix} f^x \\ f^y \\ f^z \end{bmatrix} \leq
\begin{bmatrix} 0 \\ 0 \\ 0 \\ 0 \\ 0 \end{bmatrix}
\end{equation}

\section{Integration into the Crocoddyl Framework}
\subsection{Inequality Constraints by Penalization}
%CostModelSum, Residual, Activation
\subsection{Computing the Residual}
\subsection{Unittesting Numerical Differentiation} 




